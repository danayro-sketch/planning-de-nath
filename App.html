<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Inter, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .week {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .day-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    textarea, input {
      width: 100%;
      margin-top: 6px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .add-activity, #addCheck {
      margin-top: 6px;
      padding: 6px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .delete-activity, .delete-check {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 6px;
    }
  </style>
</head>

<body>
  <div id="app">
    <h1 style="text-align:center;">Chargement du planning...</h1>
  </div>
</body>

  <script>
   

    let user = null;
    let planningId = null;
    let planningData = null;

    async function init() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "Login.html";
        return;
      }

      user = data.session.user;

      const { data: planning, error } = await supabase
        .from("plannings")
        .select("*")
        .eq("user_id", user.id)
        .limit(1)
        .single();

      if (error && error.code !== "PGRST116") {
        document.getElementById("app").innerHTML = "<h2>Erreur : " + error.message + "</h2>";
        return;
      }

      if (!planning) {
        const defaultData = {
          globalNotes: "",
          checklist: [],
          days: [
            { day: "Lundi", tag: "Démarrage en douceur", notes: "", slots: baseSlots() },
            { day: "Mardi", tag: "Activités régulières", notes: "", slots: baseSlots() },
            { day: "Mercredi", tag: "Milieu de semaine", notes: "", slots: baseSlots() },
            { day: "Jeudi", tag: "Rythme stable", notes: "", slots: baseSlots() },
            { day: "Vendredi", tag: "Fin de semaine", notes: "", slots: baseSlots() },
            { day: "Samedi", tag: "Temps perso / loisirs", notes: "", slots: baseSlots() },
            { day: "Dimanche", tag: "Repos / préparation", notes: "", slots: baseSlots() }
          ]
        };

        const { data: newPlanning } = await supabase
          .from("plannings")
          .insert({ user_id: user.id, data: defaultData })
          .select()
          .single();

        planningId = newPlanning.id;
        planningData = newPlanning.data;
      } else {
        planningId = planning.id;
        planningData = planning.data;
      }

      loadPlanningUI();
      attachEvents();
    }

    function baseSlots() {
      return [
        { label: "Matin", activities: [] },
        { label: "Midi", activities: [] },
        { label: "Soir", activities: [] }
      ];
    }

    async function savePlanning() {
      await supabase
        .from("plannings")
        .update({ data: planningData })
        .eq("id", planningId);
    }

    function loadPlanningUI() {
     document.getElementById("app").innerHTML = `
        <div class="container">
          <header>
            <h1>Planning d’activités</h1>
            <button id="logoutBtn" class="logout">Déconnexion</button>
          </header>

          <section class="global-notes">
            <h2>Notes globales</h2>
            <textarea id="globalNotes">${planningData.globalNotes}</textarea>
          </section>

          <section class="week">
            ${planningData.days.map((day, index) => `
              <div class="day-card" data-day-index="${index}">
                <h3>${day.day}</h3>
                <input class="tag-input" value="${day.tag}" />

                <div class="slots">
                  ${day.slots.map((slot, sIndex) => `
                    <div class="slot" data-slot-index="${sIndex}">
                      <h4>${slot.label}</h4>
                      <ul class="activities">
                        ${slot.activities.map((act, aIndex) => `
                          <li>
                            <input class="activity-input" data-activity-index="${aIndex}" value="${act}" />
                            <button class="delete-activity">×</button>
                          </li>
                        `).join("")}
                      </ul>
                      <button class="add-activity">+ Ajouter une activité</button>
                    </div>
                  `).join("")}
                </div>

                <textarea class="day-notes">${day.notes}</textarea>
              </div>
            `).join("")}
          </section>

          <section class="checklist">
            <h2>Checklist</h2>
            <ul id="checklist">
              ${planningData.checklist.map((item, i) => `
                <li>
                  <input type="checkbox" ${item.checked ? "checked" : ""} data-index="${i}" />
                  <input class="check-text" value="${item.text}" />
                  <button class="delete-check">×</button>
                </li>
              `).join("")}
            </ul>
            <button id="addCheck">+ Ajouter une tâche</button>
          </section>
        </div>
      `;
    }

    function attachEvents() {
      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "Login.html";
      };

      document.getElementById("globalNotes").oninput = (e) => {
        planningData.globalNotes = e.target.value;
        savePlanning();
      };

      document.querySelectorAll(".tag-input").forEach((input, index) => {
        input.oninput = (e) => {
          planningData.days[index].tag = e.target.value;
          savePlanning();
        };
      });

      document.querySelectorAll(".day-notes").forEach((input, index) => {
        input.oninput = (e) => {
          planningData.days[index].notes = e.target.value;
          savePlanning();
        };
      });

      document.querySelectorAll(".add-activity").forEach((btn) => {
        btn.onclick = (e) => {
          const dayIndex = e.target.closest(".day-card").dataset.dayIndex;
          const slotIndex = e.target.closest(".slot").dataset.slotIndex;

          planningData.days[dayIndex].slots[slotIndex].activities.push("");
          savePlanning();
          loadPlanningUI();
          attachEvents();
        };
      });

      document.querySelectorAll(".delete-activity").forEach((btn) => {
        btn.onclick = (e) => {
          const dayIndex = e.target.closest(".day-card").dataset.dayIndex;
          const slotIndex = e.target.closest(".slot").dataset.slotIndex;
          const actIndex = e.target.previousElementSibling.dataset.activityIndex;

          planningData.days[dayIndex].slots[slotIndex].activities.splice(actIndex, 1);
          savePlanning();
          loadPlanningUI();
          attachEvents();
        };
      });

      document.querySelectorAll(".activity-input").forEach((input) => {
        input.oninput = (e) => {
          const dayIndex = e.target.closest(".day-card").dataset.dayIndex;
          const slotIndex = e.target.closest(".slot").dataset.slotIndex;
          const actIndex = e.target.dataset.activityIndex;

          planningData.days[dayIndex].slots[slotIndex].activities[actIndex] = e.target.value;
          savePlanning();
        };
      });

      document.getElementById("addCheck").onclick = () => {
        planningData.checklist.push({ text: "", checked: false });
        savePlanning();
        loadPlanningUI();
        attachEvents();
      };

      document.querySelectorAll(".delete-check").forEach((btn) => {
        btn.onclick = (e) => {
          const index = e.target.previousElementSibling.previousElementSibling.dataset.index;
          planningData.checklist.splice(index, 1);
          savePlanning();
          loadPlanningUI();
          attachEvents();
        };
      });

      document.querySelectorAll("#checklist input[type='checkbox']").forEach((checkbox) => {
        checkbox.onchange = (e) => {
          const index = e.target.dataset.index;
          planningData.checklist[index].checked = e.target.checked;
          savePlanning();
        };
      });

      document.querySelectorAll(".check-text").forEach((input, index) => {
        input.oninput = (e) => {
          planningData.checklist[index].text = e.target.value;
          savePlanning();
        };
      });
    }

    init();
  </script>
</body>
</html>
