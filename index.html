<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Inter, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #111827;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .logout {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .top-bar label {
      font-size: 14px;
      color: #4b5563;
    }
    input[type="date"] {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
    }
    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
    }
    .card {
      background: white;
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .week {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 14px;
      margin-top: 10px;
    }
    .day-card {
      background: #ffffff;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    .day-card h3 {
      margin: 0 0 4px;
      font-size: 15px;
    }
    .tag-input {
      font-size: 12px;
      margin-bottom: 6px;
    }
    textarea, input[type="text"] {
      width: 100%;
      margin-top: 4px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .slots {
      margin-top: 6px;
    }
    .slot {
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .slot h4 {
      margin: 0 0 4px;
      font-size: 13px;
      color: #374151;
    }
    .activities {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .activities li {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      gap: 4px;
    }
    .activity-input {
      flex: 1;
    }
    .add-activity, #addCheck, #addDailyActivity, #addProject {
      margin-top: 6px;
      padding: 6px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-activity, .delete-check, .delete-project {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    .checklist ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .checklist li {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .check-text {
      flex: 1;
    }
    .daily-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    .daily-header span {
      font-size: 13px;
      color: #6b7280;
    }
    .matrix {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 6px;
      margin-top: 8px;
    }
    .matrix-cell {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 6px;
      font-size: 12px;
      background: #f9fafb;
    }
    .matrix-cell h4 {
      margin: 0 0 4px;
      font-size: 12px;
      color: #374151;
    }
    .matrix-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .matrix-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .pill-week {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1d4ed8;
      font-size: 11px;
    }
    .pill-day {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 11px;
    }
  </style>
</head>

<body>
  <h1 style="text-align:center;">Chargement du planning...</h1>

  <script>
    const supabase = window.supabase.createClient(
      "https://abcd1234.supabase.co",
      "TA_CLÉ_ANON_ICI"
    );

    let user = null;

    // Hebdo
    let planningId = null;
    let planningData = null;

    // Journalier
    let selectedDate = null; // "2025-02-24"
    let dailyId = null;
    let dailyData = null;

    async function init() {
      const { data } = await supabase.auth.getSession();
      if (!data.session) {
        window.location.href = "Login.html";
        return;
      }

      user = data.session.user;

      await loadWeeklyPlanning();
      selectedDate = new Date().toISOString().slice(0, 10);
      await loadDailyPlanning(selectedDate);

      renderUI();
      attachGlobalEvents();
    }

    function baseSlots() {
      return [
        { label: "Matin", activities: [] },
        { label: "Midi", activities: [] },
        { label: "Soir", activities: [] }
      ];
    }

    async function loadWeeklyPlanning() {
      const { data: planning, error } = await supabase
        .from("plannings")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (error && error.code !== "PGRST116") {
        document.body.innerHTML = "<h2>Erreur : " + error.message + "</h2>";
        throw error;
      }

      if (!planning) {
        const defaultData = {
          globalNotes: "",
          checklist: [],
          days: [
            { day: "Lundi", tag: "Démarrage en douceur", notes: "", slots: baseSlots() },
            { day: "Mardi", tag: "Activités régulières", notes: "", slots: baseSlots() },
            { day: "Mercredi", tag: "Milieu de semaine", notes: "", slots: baseSlots() },
            { day: "Jeudi", tag: "Rythme stable", notes: "", slots: baseSlots() },
            { day: "Vendredi", tag: "Fin de semaine", notes: "", slots: baseSlots() },
            { day: "Samedi", tag: "Temps perso / loisirs", notes: "", slots: baseSlots() },
            { day: "Dimanche", tag: "Repos / préparation", notes: "", slots: baseSlots() }
          ]
        };

        const { data: newPlanning } = await supabase
          .from("plannings")
          .insert({ user_id: user.id, data: defaultData })
          .select()
          .single();

        planningId = newPlanning.id;
        planningData = newPlanning.data;
      } else {
        planningId = planning.id;
        planningData = planning.data;
      }
    }

    async function loadDailyPlanning(dateStr) {
      const { data: daily, error } = await supabase
        .from("daily_plannings")
        .select("*")
        .eq("user_id", user.id)
        .eq("date", dateStr)
        .single();

      if (error && error.code !== "PGRST116") {
        console.error("Erreur daily_plannings:", error);
        throw error;
      }

      if (!daily) {
        const defaultDaily = {
          notes: "",
          checklist: [],
          slots: baseSlots(),
          projects: [] // { title, impact (1/2), urgency (1/2) }
        };

        const { data: newDaily } = await supabase
          .from("daily_plannings")
          .insert({
            user_id: user.id,
            date: dateStr,
            data: defaultDaily
          })
          .select()
          .single();

        dailyId = newDaily.id;
        dailyData = newDaily.data;
      } else {
        dailyId = daily.id;
        dailyData = daily.data;
      }
    }

    async function saveWeekly() {
      await supabase
        .from("plannings")
        .update({ data: planningData })
        .eq("id", planningId);
    }

    async function saveDaily() {
      await supabase
        .from("daily_plannings")
        .update({ data: dailyData })
        .eq("id", dailyId);
    }

    function formatDateFr(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("fr-FR", { weekday: "long", day: "2-digit", month: "short", year: "numeric" });
    }

    function renderUI() {
      document.body.innerHTML = `
        <div class="container">
          <header>
            <div>
              <h1>Planning d’activités</h1>
              <span class="pill-week">Vue semaine</span>
              <span class="pill-day">Vue journée</span>
            </div>
            <button id="logoutBtn" class="logout">Déconnexion</button>
          </header>

          <div class="top-bar">
            <label for="datePicker">Journée sélectionnée :</label>
            <input type="date" id="datePicker" value="${selectedDate}" />
            <span>${formatDateFr(selectedDate)}</span>
          </div>

          <div class="layout">
            <!-- Colonne gauche : semaine -->
            <div>
              <div class="card">
                <h2>Notes globales semaine</h2>
                <textarea id="globalNotes">${planningData.globalNotes || ""}</textarea>
              </div>

              <div class="card checklist">
                <h2>Checklist semaine</h2>
                <ul id="weekChecklist">
                  ${planningData.checklist.map((item, i) => `
                    <li>
                      <input type="checkbox" ${item.checked ? "checked" : ""} data-index="${i}" />
                      <input class="check-text" data-index="${i}" value="${item.text}" />
                      <button class="delete-check" data-index="${i}">×</button>
                    </li>
                  `).join("")}
                </ul>
                <button id="addWeekCheck">+ Ajouter une tâche</button>
              </div>

              <div class="card">
                <h2>Planning hebdomadaire</h2>
                <div class="week">
                  ${planningData.days.map((day, index) => `
                    <div class="day-card" data-day-index="${index}">
                      <h3>${day.day}</h3>
                      <input class="tag-input" value="${day.tag}" placeholder="Tag du jour" />

                      <div class="slots">
                        ${day.slots.map((slot, sIndex) => `
                          <div class="slot" data-slot-index="${sIndex}">
                            <h4>${slot.label}</h4>
                            <ul class="activities">
                              ${slot.activities.map((act, aIndex) => `
                                <li>
                                  <input class="activity-input" data-activity-index="${aIndex}" value="${act}" />
                                  <button class="delete-activity">×</button>
                                </li>
                              `).join("")}
                            </ul>
                            <button class="add-activity">+ Ajouter une activité</button>
                          </div>
                        `).join("")}
                      </div>

                      <textarea class="day-notes" placeholder="Notes du jour">${day.notes}</textarea>
                    </div>
                  `).join("")}
                </div>
              </div>
            </div>

            <!-- Colonne droite : journée -->
            <div>
              <div class="card">
                <div class="daily-header">
                  <h2>Journée du ${formatDateFr(selectedDate)}</h2>
                  <span>Matin / Midi / Soir + notes</span>
                </div>

                <div class="slots">
                  ${dailyData.slots.map((slot, sIndex) => `
                    <div class="slot" data-dslot-index="${sIndex}">
                      <h4>${slot.label}</h4>
                      <ul class="activities">
                        ${slot.activities.map((act, aIndex) => `
                          <li>
                            <input class="daily-activity-input" data-activity-index="${aIndex}" value="${act}" />
                            <button class="delete-daily-activity">×</button>
                          </li>
                        `).join("")}
                      </ul>
                      <button class="add-daily-activity">+ Ajouter une activité</button>
                    </div>
                  `).join("")}
                </div>

                <h3>Notes de la journée</h3>
                <textarea id="dailyNotes">${dailyData.notes || ""}</textarea>
              </div>

              <div class="card checklist">
                <h2>Checklist journée</h2>
                <ul id="dailyChecklist">
                  ${dailyData.checklist.map((item, i) => `
                    <li>
                      <input type="checkbox" ${item.checked ? "checked" : ""} data-index="${i}" />
                      <input class="check-text daily-check-text" data-index="${i}" value="${item.text}" />
                      <button class="delete-daily-check" data-index="${i}">×</button>
                    </li>
                  `).join("")}
                </ul>
                <button id="addDailyCheck">+ Ajouter une tâche</button>
              </div>

              <div class="card">
                <h2>Matrice de criticité (Impact / Urgence)</h2>
                <div style="display:flex; gap:6px; margin-bottom:6px;">
                  <input type="text" id="projectTitle" placeholder="Nom du projet" />
                  <select id="projectImpact">
                    <option value="1">Impact faible</option>
                    <option value="2">Impact fort</option>
                  </select>
                  <select id="projectUrgency">
                    <option value="1">Urgence faible</option>
                    <option value="2">Urgence forte</option>
                  </select>
                </div>
                <button id="addProject">Ajouter projet</button>

                <div class="matrix">
                  <div class="matrix-cell" data-cell="1-1">
                    <h4>Impact faible / Urgence faible</h4>
                    <ul class="matrix-list">
                      ${dailyData.projects
                        .filter(p => p.impact === 1 && p.urgency === 1)
                        .map((p, i) => `
                          <li data-pindex="${i}">
                            <span>${p.title}</span>
                            <button class="delete-project">×</button>
                          </li>
                        `).join("")}
                    </ul>
                  </div>
                  <div class="matrix-cell" data-cell="1-2">
                    <h4>Impact faible / Urgence forte</h4>
                    <ul class="matrix-list">
                      ${dailyData.projects
                        .filter(p => p.impact === 1 && p.urgency === 2)
                        .map((p, i) => `
                          <li data-pindex="${i}">
                            <span>${p.title}</span>
                            <button class="delete-project">×</button>
                          </li>
                        `).join("")}
                    </ul>
                  </div>
                  <div class="matrix-cell" data-cell="2-1">
                    <h4>Impact fort / Urgence faible</h4>
                    <ul class="matrix-list">
                      ${dailyData.projects
                        .filter(p => p.impact === 2 && p.urgency === 1)
                        .map((p, i) => `
                          <li data-pindex="${i}">
                            <span>${p.title}</span>
                            <button class="delete-project">×</button>
                          </li>
                        `).join("")}
                    </ul>
                  </div>
                  <div class="matrix-cell" data-cell="2-2">
                    <h4>Impact fort / Urgence forte</h4>
                    <ul class="matrix-list">
                      ${dailyData.projects
                        .filter(p => p.impact === 2 && p.urgency === 2)
                        .map((p, i) => `
                          <li data-pindex="${i}">
                            <span>${p.title}</span>
                            <button class="delete-project">×</button>
                          </li>
                        `).join("")}
                    </ul>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      `;
    }

    function attachGlobalEvents() {
      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "Login.html";
      };

      // Date picker
      document.getElementById("datePicker").onchange = async (e) => {
        selectedDate = e.target.value;
        await loadDailyPlanning(selectedDate);
        renderUI();
        attachGlobalEvents();
        attachWeekEvents();
        attachDayEvents();
      };

      attachWeekEvents();
      attachDayEvents();
    }

    function attachWeekEvents() {
      // Notes globales semaine
      const globalNotes = document.getElementById("globalNotes");
      if (globalNotes) {
        globalNotes.oninput = (e) => {
          planningData.globalNotes = e.target.value;
          saveWeekly();
        };
      }

      // Checklist semaine
      document.getElementById("addWeekCheck").onclick = () => {
        planningData.checklist.push({ text: "", checked: false });
        saveWeekly();
        renderUI();
        attachGlobalEvents();
      };

      document.querySelectorAll("#weekChecklist input[type='checkbox']").forEach((cb) => {
        cb.onchange = (e) => {
          const i = e.target.dataset.index;
          planningData.checklist[i].checked = e.target.checked;
          saveWeekly();
        };
      });

      document.querySelectorAll("#weekChecklist .check-text").forEach((input) => {
        input.oninput = (e) => {
          const i = e.target.dataset.index;
          planningData.checklist[i].text = e.target.value;
          saveWeekly();
        };
      });

      document.querySelectorAll("#weekChecklist .delete-check").forEach((btn) => {
        btn.onclick = (e) => {
          const i = e.target.dataset.index;
          planningData.checklist.splice(i, 1);
          saveWeekly();
          renderUI();
          attachGlobalEvents();
        };
      });

      // Tags, notes, activités semaine
      document.querySelectorAll(".day-card").forEach((card, dayIndex) => {
        const tagInput = card.querySelector(".tag-input");
        tagInput.oninput = (e) => {
          planningData.days[dayIndex].tag = e.target.value;
          saveWeekly();
        };

        const dayNotes = card.querySelector(".day-notes");
        dayNotes.oninput = (e) => {
          planningData.days[dayIndex].notes = e.target.value;
          saveWeekly();
        };

        card.querySelectorAll(".slot").forEach((slotEl, slotIndex) => {
          slotEl.querySelectorAll(".activity-input").forEach((input, aIndex) => {
            input.oninput = (e) => {
              planningData.days[dayIndex].slots[slotIndex].activities[aIndex] = e.target.value;
              saveWeekly();
            };
          });

          const addBtn = slotEl.querySelector(".add-activity");
          addBtn.onclick = () => {
            planningData.days[dayIndex].slots[slotIndex].activities.push("");
            saveWeekly();
            renderUI();
            attachGlobalEvents();
          };

          slotEl.querySelectorAll(".delete-activity").forEach((btn, aIndex) => {
            btn.onclick = () => {
              planningData.days[dayIndex].slots[slotIndex].activities.splice(aIndex, 1);
              saveWeekly();
              renderUI();
              attachGlobalEvents();
            };
          });
        });
      });
    }

    function attachDayEvents() {
      // Slots journée
      document.querySelectorAll(".slot[data-dslot-index]").forEach((slotEl) => {
        const sIndex = slotEl.dataset.dslotIndex;

        slotEl.querySelectorAll(".daily-activity-input").forEach((input, aIndex) => {
          input.oninput = (e) => {
            dailyData.slots[sIndex].activities[aIndex] = e.target.value;
            saveDaily();
          };
        });

        const addBtn = slotEl.querySelector(".add-daily-activity");
        addBtn.onclick = () => {
          dailyData.slots[sIndex].activities.push("");
          saveDaily();
          renderUI();
          attachGlobalEvents();
        };

        slotEl.querySelectorAll(".delete-daily-activity").forEach((btn, aIndex) => {
          btn.onclick = () => {
            dailyData.slots[sIndex].activities.splice(aIndex, 1);
            saveDaily();
            renderUI();
            attachGlobalEvents();
          };
        });
      });

      // Notes journée
      const dailyNotes = document.getElementById("dailyNotes");
      dailyNotes.oninput = (e) => {
        dailyData.notes = e.target.value;
        saveDaily();
      };

      // Checklist journée
      document.getElementById("addDailyCheck").onclick = () => {
        dailyData.checklist.push({ text: "", checked: false });
        saveDaily();
        renderUI();
        attachGlobalEvents();
      };

      document.querySelectorAll("#dailyChecklist input[type='checkbox']").forEach((cb) => {
        cb.onchange = (e) => {
          const i = e.target.dataset.index;
          dailyData.checklist[i].checked = e.target.checked;
          saveDaily();
        };
      });

      document.querySelectorAll("#dailyChecklist .daily-check-text").forEach((input) => {
        input.oninput = (e) => {
          const i = e.target.dataset.index;
          dailyData.checklist[i].text = e.target.value;
          saveDaily();
        };
      });

      document.querySelectorAll("#dailyChecklist .delete-daily-check").forEach((btn) => {
        btn.onclick = (e) => {
          const i = e.target.dataset.index;
          dailyData.checklist.splice(i, 1);
          saveDaily();
          renderUI();
          attachGlobalEvents();
        };
      });

      // Matrice de criticité
      document.getElementById("addProject").onclick = () => {
        const title = document.getElementById("projectTitle").value.trim();
        const impact = Number(document.getElementById("projectImpact").value);
        const urgency = Number(document.getElementById("projectUrgency").value);
        if (!title) return;

        dailyData.projects.push({ title, impact, urgency });
        document.getElementById("projectTitle").value = "";
        saveDaily();
        renderUI();
        attachGlobalEvents();
      };

      document.querySelectorAll(".matrix .delete-project").forEach((btn) => {
        btn.onclick = (e) => {
          const li = e.target.closest("li");
          const pIndex = Number(li.dataset.pindex);
          dailyData.projects.splice(pIndex, 1);
          saveDaily();
          renderUI();
          attachGlobalEvents();
        };
      });
    }

    init();
  </script>
</body>
</html>



