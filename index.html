<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning 7 jours pastel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Inter, sans-serif;
      background: #F7F7FB;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
    }

    .day-card {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #E0E7FF;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .day-card h2 {
      text-align: center;
      font-size: 16px;
      margin: 0 0 10px;
    }

    .slot {
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 10px;
    }

    .slot[data-slot="morning"] { background: #E3F2FD; }
    .slot[data-slot="noon"]    { background: #FFF3E0; }
    .slot[data-slot="evening"] { background: #F3E5F5; }

    .activity {
      background: #FFFFFF;
      border-radius: 8px;
      padding: 6px;
      margin-bottom: 6px;
      border: 1px solid #E0E7FF;
    }

    input, select {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #D1D5DB;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #A5B4FC;
      color: white;
      font-size: 13px;
      width: 100%;
    }

    .btn-danger {
      background: #FCA5A5;
    }

    .todo-card {
      margin-top: 20px;
      background: #FFFFFF;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #E0E7FF;
    }

    .todo-list li {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .matrix {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .matrix-cell {
      background: #FFFFFF;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #E0E7FF;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Planning pastel â€“ 7 jours visibles</h1>

    <input type="date" id="weekStart" />

    <div class="week-grid" id="weekGrid"></div>

    <div class="todo-card">
      <h2>Toâ€‘do list</h2>
      <ul id="todoList" class="todo-list"></ul>
      <button id="addTodo" class="btn">+ Ajouter une tÃ¢che</button>
    </div>

    <div class="matrix">
      <div class="matrix-cell" id="low-low"><h3>Faible / Faible</h3></div>
      <div class="matrix-cell" id="low-high"><h3>Faible / Fort</h3></div>
      <div class="matrix-cell" id="high-low"><h3>Fort / Faible</h3></div>
      <div class="matrix-cell" id="high-high"><h3>Fort / Fort</h3></div>
    </div>
  </div>

<script>
  const supabase = window.supabase.createClient(
      "https://wgspawpymauabfdzhcwh.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indnc3Bhd3B5bWF1YWJmZHpoY3doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MDcyOTcsImV4cCI6MjA4NTA4MzI5N30.BV7w18Nmr9aMMAdsXdLovy6zowODwFvphXgWWSsVCHs"
    );

  let currentUser = null;
  let planningId = null;
  let weekDates = [];

  async function init() {
    const { data } = await supabase.auth.getSession();
    if (!data.session) {
      alert("Connecte-toi d'abord.");
      return;
    }

    currentUser = data.session.user;

    await loadOrCreatePlanning();
    setWeek(new Date());
  }

  async function loadOrCreatePlanning() {
    const { data } = await supabase
      .from("plannings")
      .select("*")
      .eq("user_id", currentUser.id)
      .eq("type", "personal")
      .single();

    if (!data) {
      const { data: newP } = await supabase
        .from("plannings")
        .insert({
          user_id: currentUser.id,
          type: "personal",
          name: "Mon planning perso"
        })
        .select()
        .single();

      planningId = newP.id;
    } else {
      planningId = data.id;
    }
  }
function attachAddButtons() {
  document.querySelectorAll(".add-btn").forEach(btn => {
    btn.onclick = async () => {
      const date = btn.dataset.date;
      const slot = btn.dataset.slot;

      await addActivity(date, slot);
      await renderWeek(); // ðŸ”¥ recharge la semaine et rÃ©attache les Ã©vÃ©nements
    };
  });
}
   async function renderWeek() {
  const grid = document.getElementById("weekGrid");
  grid.innerHTML = "";

  for (const date of weekDates) {
    const dayCard = document.createElement("div");
    dayCard.className = "day-card";

    dayCard.innerHTML = `
      <h2>${formatDate(date)}</h2>

      <div class="slot" data-slot="morning">
        <h3>Matin</h3>
        <div id="m-${date}"></div>
        <button class="btn add-btn" data-date="${date}" data-slot="morning">+ Ajouter</button>
      </div>

      <div class="slot" data-slot="noon">
        <h3>Midi</h3>
        <div id="n-${date}"></div>
        <button class="btn add-btn" data-date="${date}" data-slot="noon">+ Ajouter</button>
      </div>

      <div class="slot" data-slot="evening">
        <h3>Soir</h3>
        <div id="e-${date}"></div>
        <button class="btn add-btn" data-date="${date}" data-slot="evening">+ Ajouter</button>
      </div>
    `;

    grid.appendChild(dayCard);

    await loadDay(date);
  }

  // ðŸ”¥ Câ€™est ici que tout se joue
  attachAddButtons();
  attachActivityEvents();
}
 
  function setWeek(date) {
    const monday = new Date(date);
    monday.setDate(monday.getDate() - monday.getDay() + 1);

    weekDates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      weekDates.push(d.toISOString().slice(0,10));
    }

    document.getElementById("weekStart").value = weekDates[0];
    renderWeek();
  }

 

  function formatDate(d) {
    return new Date(d).toLocaleDateString("fr-FR", {
      weekday: "long",
      day: "2-digit",
      month: "short"
    });
  }

  async function loadDay(date) {
    const { data: day } = await supabase
      .from("planning_days")
      .select("*")
      .eq("planning_id", planningId)
      .eq("date", date)
      .single();

    let dayId = null;

    if (!day) {
      const { data: newDay } = await supabase
        .from("planning_days")
        .insert({ planning_id: planningId, date })
        .select()
        .single();
      dayId = newDay.id;
    } else {
      dayId = day.id;
    }

    const { data: acts } = await supabase
      .from("activities")
      .select("*")
      .eq("planning_day_id", dayId);

    renderActivities(date, acts || []);
  }

  function renderActivities(date, acts) {
    ["morning","noon","evening"].forEach(slot => {
      const container = document.getElementById(slot[0] + "-" + date);
      container.innerHTML = "";

      acts.filter(a => a.slot === slot).forEach(a => {
        const div = document.createElement("div");
        div.className = "activity";
        div.style.background = computeColor(a);

        div.innerHTML = `
          <input data-id="${a.id}" class="name" value="${a.name || ""}" placeholder="Nom">
          <input data-id="${a.id}" class="cat" value="${a.category || ""}" placeholder="CatÃ©gorie">
          <input data-id="${a.id}" class="dur" type="number" value="${a.duration || 0}" placeholder="DurÃ©e (min)">
          <input data-id="${a.id}" class="due" type="date" value="${a.due_date || ""}">
          <button class="btn btn-danger" data-del="${a.id}">Supprimer</button>
        `;

        container.appendChild(div);
      });
    });

    attachActivityEvents();
  }

  function computeColor(a) {
    if (!a.due_date) return "#E0F7E9";

    const start = new Date(a.created_at || a.due_date);
    const end = new Date(a.due_date);
    const now = new Date();

    const total = end - start;
    const elapsed = Math.min(Math.max(now - start, 0), total);
    const ratio = total === 0 ? 1 : elapsed / total;

    const from = { r: 224, g: 247, b: 233 };
    const to   = { r: 253, g: 226, b: 226 };

    const r = Math.round(from.r + (to.r - from.r) * ratio);
    const g = Math.round(from.g + (to.g - from.g) * ratio);
    const b = Math.round(from.b + (to.b - from.b) * ratio);

    return `rgb(${r},${g},${b})`;
  }


  async function addActivity(date, slot) {
    const { data: day } = await supabase
      .from("planning_days")
      .select("*")
      .eq("planning_id", planningId)
      .eq("date", date)
      .single();

    const dayId = day.id;

    await supabase.from("activities").insert({
      planning_day_id: dayId,
      slot,
      name: "",
      category: "",
      duration: 0,
      created_at: new Date().toISOString(),
      done: false
    });
  }

  function attachActivityEvents() {
    document.querySelectorAll(".name").forEach(i => {
      i.oninput = () => update(i.dataset.id, { name: i.value });
    });

    document.querySelectorAll(".cat").forEach(i => {
      i.oninput = () => update(i.dataset.id, { category: i.value });
    });

    document.querySelectorAll(".dur").forEach(i => {
      i.onchange = () => update(i.dataset.id, { duration: Number(i.value) });
    });

    document.querySelectorAll(".due").forEach(i => {
      i.onchange = () => update(i.dataset.id, { due_date: i.value });
    });

    document.querySelectorAll("[data-del]").forEach(btn => {
      btn.onclick = async () => {
        await supabase.from("activities").delete().eq("id", btn.dataset.del);
        await renderWeek();
      };
    });
  }

  async function update(id, data) {
    await supabase.from("activities").update(data).eq("id", id);
  }

  init();
</script>

</body>
</html>

